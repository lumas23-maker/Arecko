{% extends 'base.html' %}

{% block content %}
<div style="max-width: 700px; margin: 40px auto; padding: 20px; font-family: -apple-system, sans-serif;">
    <h2 style="color: #1c1e21;">Create Newsletter üìß</h2>
    <p style="color: #65676b;">Use AI to generate a professional newsletter for your customers. Customize the content and send!</p>

    <form method="POST" id="newsletter-form" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 20px;">
        {% csrf_token %}

        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold;">Newsletter Topic / Theme</label>
            <input type="text" name="topic" id="topic" required placeholder="e.g., Spring Sale, New Inventory, Holiday Specials, Thank You Message"
                   style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold;">Key Points to Include (Optional)</label>
            <textarea name="key_points" id="key_points" placeholder="e.g., 20% off all vehicles, Free oil change with purchase, Extended hours this weekend"
                      style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; height: 80px; font-family: inherit; box-sizing: border-box;"></textarea>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold;">Tone</label>
            <select name="tone" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
                <option value="professional">Professional</option>
                <option value="friendly">Friendly & Casual</option>
                <option value="excited">Excited & Energetic</option>
                <option value="grateful">Grateful & Appreciative</option>
            </select>
        </div>

        <button type="button" id="generate-btn" onclick="generateNewsletter()"
                style="width: 100%; background: #6c5ce7; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 15px;">
            ‚ú® Generate with AI
        </button>

        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold;">Newsletter Content</label>
            <textarea name="content" id="newsletter-content" required placeholder="Click 'Generate with AI' above, or write your own content here..."
                      style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; height: 250px; font-family: inherit; box-sizing: border-box;"></textarea>
            <small style="color: #65676b;">You can edit the AI-generated content before sending.</small>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold;">Recipient Emails (comma-separated)</label>
            <textarea name="recipients" required placeholder="customer1@email.com, customer2@email.com"
                      style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; height: 80px; font-family: inherit; box-sizing: border-box;"></textarea>
        </div>

        <button type="submit" style="width: 100%; background: #008cff; color: white; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1em;">
            üì§ Send Newsletter
        </button>
    </form>
</div>

<script>
async function generateNewsletter() {
    const btn = document.getElementById('generate-btn');
    const topic = document.getElementById('topic').value;
    const keyPoints = document.getElementById('key_points').value;
    const tone = document.querySelector('select[name="tone"]').value;
    const contentArea = document.getElementById('newsletter-content');

    if (!topic) {
        alert('Please enter a newsletter topic first!');
        return;
    }

    btn.textContent = '‚è≥ Generating...';
    btn.disabled = true;

    try {
        const response = await fetch('{% url "generate_newsletter_ai" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                topic: topic,
                key_points: keyPoints,
                tone: tone,
                business_name: '{{ request.user.username }}'
            })
        });

        const data = await response.json();
        if (data.content) {
            contentArea.value = data.content;
        } else {
            alert('Error generating content. Please try again or write your own.');
        }
    } catch (error) {
        alert('Error connecting to AI. Please write your own content.');
        console.error(error);
    }

    btn.textContent = '‚ú® Generate with AI';
    btn.disabled = false;
}
</script>
{% endblock %}
