{% extends 'base.html' %}

{% block content %}
<div style="max-width: 600px; margin: 0 auto; font-family: -apple-system, sans-serif;">

    <!-- Stories Bar -->
    {% if stories %}
    <div style="background: white; border-radius: 12px; padding: 15px; margin: 20px 0; box-shadow: 0 2px 12px rgba(0,0,0,0.1);">
        <div style="display: flex; gap: 15px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: thin;">
            {% if not user.is_staff %}
            <!-- Create Story Button -->
            <a href="{% url 'post_story' %}" style="text-decoration: none; flex-shrink: 0;">
                <div style="width: 80px; text-align: center;">
                    <div style="width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; border: 3px solid #667eea;">
                        <span style="color: white; font-size: 28px;">+</span>
                    </div>
                    <span style="font-size: 0.75em; color: #333; font-weight: 500;">Post</span>
                </div>
            </a>
            {% endif %}

            <!-- Story Thumbnails -->
            {% for story in stories|slice:":15" %}
            <a href="{% url 'recko_detail' story.pk %}" style="text-decoration: none; flex-shrink: 0;">
                <div style="width: 80px; text-align: center;">
                    <div style="width: 70px; height: 70px; border-radius: 50%; background: {% if story.media %}url('{{ story.media.url }}') center/cover{% else %}linear-gradient(135deg, #f093fb, #f5576c){% endif %}; margin: 0 auto 8px; border: 3px solid {% if story.is_verified %}#38ef7d{% else %}#667eea{% endif %}; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        {% if not story.media %}
                        <span style="color: white; font-size: 24px; font-weight: 600;">{{ story.business_name.0|upper }}</span>
                        {% elif story.is_video %}
                        <div style="position: absolute; color: white; font-size: 20px; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">‚ñ∂</div>
                        {% endif %}
                    </div>
                    <span style="font-size: 0.7em; color: #333; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ story.business_name|truncatechars:10 }}</span>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if not user.is_staff %}
    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <a href="{% url 'post_story' %}" style="flex: 1; background: linear-gradient(135deg, #667eea, #764ba2); color: white; text-align: center; padding: 12px; border-radius: 8px; text-decoration: none; font-weight: bold;">+ Post an Arecko-mendation</a>
    </div>
    {% endif %}

    <h2 style="text-align: center; color: #1c1e21;">Latest Arecko-mendations</h2>

    {% for story in stories %}
    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.1);">

        <!-- User info with profile link -->
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
            {% if story.user %}
            <a href="{% url 'user_profile' story.user.username %}" style="text-decoration: none; display: flex; align-items: center; gap: 8px;">
                {% if story.user.profile.profile_picture %}
                <img src="{{ story.user.profile.profile_picture.url }}" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">
                {% else %}
                <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px;">
                    {{ story.user.first_name.0|default:story.user.username.0|upper }}
                </div>
                {% endif %}
                <span style="font-weight: 600; color: #333;">{{ story.user.first_name|default:story.user.username }}</span>
            </a>
            {% else %}
            <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #a8a8a8, #6b6b6b); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px;">
                    {{ story.get_poster_name.0|upper }}
                </div>
                <span style="font-weight: 600; color: #333;">{{ story.get_poster_name }}</span>
            </div>
            {% endif %}

            {% if story.is_verified %}
                <span style="background: #d4edda; color: #155724; font-size: 0.7em; padding: 3px 8px; border-radius: 10px; font-weight: 600;">‚úì Verified</span>
            {% endif %}

            {% if story.user and story.user.is_staff or story.user and story.user.is_superuser %}
                <span style="background: #e7f3ff; color: #1877f2; font-size: 0.7em; padding: 3px 8px; border-radius: 10px; font-weight: 600;">Business</span>
            {% endif %}
        </div>

        <p style="margin: 0 0 5px 0;">
            <a href="{% url 'recko_detail' story.pk %}" style="text-decoration: none; color: #667eea; font-weight: bold;">
                {{ story.business_name }}
            </a>
            {% if story.industry and story.industry != 'other' %}
                <span style="background: #f0f0f0; color: #666; font-size: 0.7em; padding: 2px 8px; border-radius: 10px; margin-left: 5px;">{{ story.get_industry_display }}</span>
            {% endif %}
        </p>
        <p style="margin: 0; color: #444;">"{{ story.story }}"</p>

        {% if story.media %}
            <div style="margin-top: 15px; border-radius: 8px; overflow: hidden; background: #000;">
                {% if story.is_video %}
                    <video controls preload="metadata" playsinline style="display: block; width: 100%; max-height: 500px;">
                        <source src="{{ story.media.url }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                {% else %}
                    <img src="{{ story.media.url }}" style="width: 100%; display: block;" alt="Business Media">
                {% endif %}
            </div>
        {% endif %}

        <!-- Reactions Display -->
        {% if story.reactions.count > 0 %}
        <div style="display: flex; align-items: center; gap: 5px; margin-top: 12px; padding: 8px 0; font-size: 0.85em; color: #666;">
            <span id="reaction-emojis-{{ story.id }}">
                {% regroup story.reactions.all by reaction_type as reaction_groups %}
                {% for group in reaction_groups %}{{ group.grouper|slice:":2" }}{% endfor %}
            </span>
            <span id="reaction-count-{{ story.id }}">{{ story.reactions.count }}</span>
        </div>
        {% endif %}

        <!-- Reaction Bar -->
        <div style="display: flex; gap: 15px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 12px; align-items: center;">
            <!-- Reaction Button with Picker -->
            <div class="reaction-container" style="position: relative;">
                <button onclick="toggleReactionPicker({{ story.id }})" id="react-btn-{{ story.id }}"
                        style="background: none; border: none; cursor: pointer; font-size: 1em; padding: 5px 10px; border-radius: 6px; transition: background 0.2s; display: flex; align-items: center; gap: 5px;"
                        onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='none'">
                    {% with user_reaction=story.reactions.all|dictsort:"user_id" %}
                        <span id="user-reaction-{{ story.id }}">
                            {% for r in story.reactions.all %}{% if r.user == request.user %}{% if r.reaction_type == 'like' %}üëç{% elif r.reaction_type == 'love' %}‚ù§Ô∏è{% elif r.reaction_type == 'haha' %}üòÇ{% elif r.reaction_type == 'wow' %}üòÆ{% elif r.reaction_type == 'sad' %}üò¢{% elif r.reaction_type == 'angry' %}üò°{% endif %}{% endif %}{% empty %}ü§ç{% endfor %}
                        </span>
                    {% endwith %}
                    <span style="color: #666;">React</span>
                </button>

                <!-- Reaction Picker Popup -->
                <div id="reaction-picker-{{ story.id }}" style="display: none; position: absolute; bottom: 100%; left: 0; background: white; border-radius: 30px; padding: 8px 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 100; white-space: nowrap;">
                    <button onclick="react({{ story.id }}, 'like')" style="background: none; border: none; cursor: pointer; font-size: 1.5em; padding: 5px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.3)'" onmouseout="this.style.transform='scale(1)'" title="Like">üëç</button>
                    <button onclick="react({{ story.id }}, 'love')" style="background: none; border: none; cursor: pointer; font-size: 1.5em; padding: 5px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.3)'" onmouseout="this.style.transform='scale(1)'" title="Love">‚ù§Ô∏è</button>
                    <button onclick="react({{ story.id }}, 'haha')" style="background: none; border: none; cursor: pointer; font-size: 1.5em; padding: 5px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.3)'" onmouseout="this.style.transform='scale(1)'" title="Haha">üòÇ</button>
                    <button onclick="react({{ story.id }}, 'wow')" style="background: none; border: none; cursor: pointer; font-size: 1.5em; padding: 5px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.3)'" onmouseout="this.style.transform='scale(1)'" title="Wow">üòÆ</button>
                    <button onclick="react({{ story.id }}, 'sad')" style="background: none; border: none; cursor: pointer; font-size: 1.5em; padding: 5px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.3)'" onmouseout="this.style.transform='scale(1)'" title="Sad">üò¢</button>
                    <button onclick="react({{ story.id }}, 'angry')" style="background: none; border: none; cursor: pointer; font-size: 1.5em; padding: 5px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.3)'" onmouseout="this.style.transform='scale(1)'" title="Angry">üò°</button>
                </div>
            </div>

            {% if story.user and story.user == request.user or user.is_superuser %}
                <a href="{% url 'delete_story' story.id %}" style="color: #ff4d4d; text-decoration: none; font-weight: bold; font-size: 0.9em;" onclick="return confirm('Delete this Recko?')">Delete</a>
            {% elif user.is_staff %}
                <a href="{% url 'delete_story' story.id %}" style="color: #ff4d4d; text-decoration: none; font-weight: bold; font-size: 0.9em;" onclick="return confirm('Delete this Recko about your business?')">Delete</a>
            {% endif %}
        </div>

        <div style="margin-top: 15px; background: #f0f2f5; padding: 15px; border-radius: 8px;">
            <p style="font-weight: bold; font-size: 0.9em; margin-bottom: 10px;">Comments:</p>
            {% for comment in story.comments.all %}
                <p style="font-size: 0.85em; margin: 5px 0;">
                    <strong>{{ comment.user.username }}</strong>: {{ comment.text }}
                </p>
            {% endfor %}
            
            <form action="{% url 'add_comment' story.id %}" method="POST" style="margin-top: 10px; display: flex; gap: 5px;">
                {% csrf_token %}
                <input type="text" name="text" placeholder="Add a comment..." style="flex: 1; border-radius: 6px; border: 1px solid #ddd; padding: 8px;" required>
                <button type="submit" style="background: #667eea; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">Post</button>
            </form>
        </div>
    </div>
    {% empty %}
    <p style="text-align: center; color: #65676b;">No recommendations yet. Be the first to post!</p>
    {% endfor %}

    <!-- Pagination -->
    {% if stories.has_other_pages %}
    <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin: 30px 0; flex-wrap: wrap;">
        {% if stories.has_previous %}
            <a href="?page=1" style="padding: 8px 14px; background: white; border-radius: 8px; text-decoration: none; color: #667eea; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">First</a>
            <a href="?page={{ stories.previous_page_number }}" style="padding: 8px 14px; background: white; border-radius: 8px; text-decoration: none; color: #667eea; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">Previous</a>
        {% endif %}

        <span style="padding: 8px 14px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 8px; font-weight: 600;">
            Page {{ stories.number }} of {{ stories.paginator.num_pages }}
        </span>

        {% if stories.has_next %}
            <a href="?page={{ stories.next_page_number }}" style="padding: 8px 14px; background: white; border-radius: 8px; text-decoration: none; color: #667eea; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">Next</a>
            <a href="?page={{ stories.paginator.num_pages }}" style="padding: 8px 14px; background: white; border-radius: 8px; text-decoration: none; color: #667eea; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">Last</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
let activePickerId = null;

function toggleReactionPicker(storyId) {
    const picker = document.getElementById('reaction-picker-' + storyId);

    // Close any other open picker
    if (activePickerId && activePickerId !== storyId) {
        document.getElementById('reaction-picker-' + activePickerId).style.display = 'none';
    }

    if (picker.style.display === 'none') {
        picker.style.display = 'flex';
        activePickerId = storyId;
    } else {
        picker.style.display = 'none';
        activePickerId = null;
    }
}

function react(storyId, reactionType) {
    // Hide picker
    document.getElementById('reaction-picker-' + storyId).style.display = 'none';
    activePickerId = null;

    // Send reaction
    fetch('/react/' + storyId + '/?type=' + reactionType, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the reaction display
            const emojis = {'like': 'üëç', 'love': '‚ù§Ô∏è', 'haha': 'üòÇ', 'wow': 'üòÆ', 'sad': 'üò¢', 'angry': 'üò°'};
            const userReactionSpan = document.getElementById('user-reaction-' + storyId);

            if (data.user_reaction) {
                userReactionSpan.textContent = emojis[data.user_reaction];
            } else {
                userReactionSpan.textContent = 'ü§ç';
            }

            // Update count display
            const countSpan = document.getElementById('reaction-count-' + storyId);
            const emojisSpan = document.getElementById('reaction-emojis-' + storyId);

            if (data.total > 0) {
                if (countSpan) countSpan.textContent = data.total;
                if (emojisSpan) emojisSpan.textContent = Object.keys(data.counts).join('');
            }

            // Reload to update reaction display properly
            location.reload();
        }
    })
    .catch(error => console.error('Error:', error));
}

// Close picker when clicking outside
document.addEventListener('click', function(e) {
    if (activePickerId && !e.target.closest('.reaction-container')) {
        document.getElementById('reaction-picker-' + activePickerId).style.display = 'none';
        activePickerId = null;
    }
});
</script>
{% endblock %}